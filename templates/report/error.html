<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ì¥ì•  ë¦¬í¬íŠ¸ ë“±ë¡</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  {% include 'layout/header.html' %}
  <div class="container">
    <h1>ì¥ì•  ë¦¬í¬íŠ¸ ë“±ë¡</h1>
    <form method="post" action="/error/submit" onsubmit="return validateForm()">
      <div class="section">
        <h2>ê¸°ë³¸ ì •ë³´</h2>
        <div class="form-row">
          <label>ë‹´ë‹¹ì*</label>
          <input type="text" value="{{ current_user_name }}" readonly disabled>
          <input type="hidden" name="manager" value="{{ current_user_name }}">

          <label>ìƒíƒœ*</label>
          <select name="status" required>
            <option value="">--ì„ íƒ--</option>
            <option value="ëŒ€ê¸°">ëŒ€ê¸°</option>
            <option value="ì§„í–‰ ì¤‘">ì§„í–‰ ì¤‘</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
          </select>
        </div>
        <div class="form-row">
          <label>ì¥ì• ì¼ì*</label><input type="date" name="error_start_date" required>
          <label>ì¥ì• ì‹œê°„*</label><input type="time" name="start_time" required>
        </div>
        <div class="form-row">
          <label>ë³µêµ¬ì¼ì</label><input type="date" name="error_end_date">
          <label>ë³µêµ¬ì‹œê°„</label><input type="time" name="end_time">
        </div>
      </div>

      <div class="section">
        <h2>ê³ ê° ë° ì‹œìŠ¤í…œ ì •ë³´</h2>
        <div class="form-row">
          <!-- ê³ ê°ì‚¬ -->
          <label>ê³ ê°ì‚¬*</label>
          <select name="client_name" id="client_name" required onchange="fetchClientOptions()">
            <option value="">--ì„ íƒ--</option>
            {% for name in client_names %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
          </select>

          <!-- ì‹œìŠ¤í…œëª… -->
          <label>ì‹œìŠ¤í…œëª…*</label>
          <select name="system_name" id="system_name" required>
            <option value="">--ì„ íƒ--</option>
          </select>

          <!-- ëŒ€ìƒ ì‹œìŠ¤í…œ/í™˜ê²½ -->
          <label>ëŒ€ìƒ ì‹œìŠ¤í…œ/í™˜ê²½*</label>
          <select name="target_env" id="target_env" required onchange="toggleCloudTypeBox()">
            <option value="">--ì„ íƒ--</option>
          </select>
        </div>
        <div class="form-row">
          <label for="target_component">êµ¬ì„±*</label>
          <select name="target_component" id="target_component" required>
            <option value="">--ì„ íƒ--</option>
          </select>


          <!-- í´ë¼ìš°ë“œ ì¢…ë¥˜ (Cloudì¼ ê²½ìš°ë§Œ í‘œì‹œ) -->
          <div id="cloud_type_box" style="display: none;">
            <label for="cloud_type">í´ë¼ìš°ë“œ ì¢…ë¥˜*</label>
            <select name="cloud_type" id="cloud_type">
              <option value="">--ì„ íƒ--</option>
              <option value="NCP">NCP</option>
              <option value="KTC">KTC</option>
              <option value="NHN">NHN</option>
            </select>

          </div>
        </div>




        <div class="section">
          <h2>ì¥ì•  ìƒì„¸ ì •ë³´</h2>
          <div class="form-row">
            <label>ê³ ê° ì˜í–¥</label><textarea name="customer_impact"></textarea>
          </div>
          <div class="form-row">
            <label>ì¥ì•  ë‚´ìš©*</label><textarea name="error_info" required></textarea>
          </div>
          <div class="form-row">
            <label>ì¥ì•  ì›ì¸</label><textarea name="error_reason"></textarea>
          </div>
          <div class="form-row">
            <label>ì¡°ì¹˜ ë‚´ìš©</label><textarea name="action_taken"></textarea>
          </div>
          <div class="form-row">
            <label>ê¸°íƒ€ì‚¬í•­</label><textarea name="etc"></textarea>
          </div>
        </div>

        <div class="button-group">
          <button type="submit">ì™„ë£Œ</button>
        </div>
    </form>
  </div>

  <script>
    function validateForm() {
      const startDate = document.querySelector('input[name="error_start_date"]').value;
      const startTime = document.querySelector('input[name="start_time"]').value;
      const endDate = document.querySelector('input[name="error_end_date"]').value;
      const endTime = document.querySelector('input[name="end_time"]').value;

      if (startDate && startTime && endDate && endTime) {
        const start = new Date(`${startDate}T${startTime}`);
        const end = new Date(`${endDate}T${endTime}`);
        if (end < start) {
          alert("ë³µêµ¬ì¼ìëŠ” ì¥ì• ì¼ìë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
          return false;
        }
      }

      return true;
    }
  </script>

  <script>
    function fetchClientOptions() {
      const clientName = document.getElementById("client_name").value;

      fetch(`/client/options?client_name=${encodeURIComponent(clientName)}`)
        .then(response => response.json())
        .then(data => {
          // ì‹œìŠ¤í…œëª… ì±„ìš°ê¸°
          const systemSelect = document.getElementById("system_name");
          systemSelect.innerHTML = `<option value="">--ì„ íƒ--</option>`;
          data.system_names.forEach(name => {
            systemSelect.innerHTML += `<option value="${name}">${name}</option>`;
          });

          // ëŒ€ìƒí™˜ê²½ ì±„ìš°ê¸°
          const envSelect = document.getElementById("target_env");
          envSelect.innerHTML = `<option value="">--ì„ íƒ--</option>`;
          data.target_envs.forEach(env => {
            envSelect.innerHTML += `<option value="${env}">${env}</option>`;
          });

          // ğŸ”¥ ì¥ì•  ëŒ€ìƒ ì±„ìš°ê¸°
          const compSelect = document.getElementById("target_component");
          compSelect.innerHTML = `<option value="">--ì„ íƒ--</option>`;
          if (data.target_components) {
            data.target_components.forEach(comp => {
              compSelect.innerHTML += `<option value="${comp}">${comp}</option>`;
            });
          }

          toggleCloudTypeBox(); // cloud_type ë…¸ì¶œì—¬ë¶€
        });

    }

    function toggleCloudTypeBox() {
      const env = document.getElementById("target_env").value;
      const box = document.getElementById("cloud_type_box");
      if (env === "Cloud") {
        box.style.display = "block";
      } else {
        box.style.display = "none";
        document.getElementById("cloud_type").value = "";
      }
    }
  </script>

</body>

</html>